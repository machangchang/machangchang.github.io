---
layout: post
title: Socket通信原理
categories: Java
description: Socket
keywords: Socket
---

## 什么是Socket？

Socket 的中文翻译过来就是“套接字”。套接字是什么，我们先来看看它的英文含义：插座。

Socket 就像一个电话插座，负责连通两端的电话，进行点对点通信，让电话可以进行通信，端口就像插座上的孔，端口不能同时被其他进程占用。而我们建立连接就像把插头插在这个插座上，创建一个 Socket 实例开始监听后，这个电话插座就时刻监听着消息的传入，谁拨通我这个“IP 地址和端口”，我就接通谁。

实际上，Socket 是在应用层和传输层之间的一个抽象层，它把 TCP/IP 层复杂的操作抽象为几个简单的接口，供应用层调用实现进程在网络中的通信。Socket 起源于 UNIX，在 UNIX 一切皆文件的思想下，进程间通信就被冠名为文件描述符（file descriptor），Socket 是一种“打开—读/写—关闭”模式的实现，服务器和客户端各自维护一个“文件”，在建立连接打开后，可以向文件写入内容供对方读取或者读取对方内容，通讯结束时关闭文件。

另外我们经常说到的Socket 所在位置如下图：

![](/images/blog/2018-06-05-Socket-1/Socket_001.jpg)

## Socket 通信过程

Socket 保证了不同计算机之间的通信，也就是网络通信。对于网站，通信模型是服务器与客户端之间的通信。两端都建立了一个 Socket 对象，然后通过 Socket 对象对数据进行传输。通常服务器处于一个无限循环，等待客户端的连接。

一图胜千言，下面是面向连接的 TCP 时序图：

![](/images/blog/2018-06-05-Socket-1/Socket_002.jpg)

### 客户端过程：

客户端的过程比较简单，创建 Socket，连接服务器，将 Socket 与远程主机连接（注意：只有 TCP 才有“连接”的概念，一些 Socket 比如 UDP、ICMP 和 ARP 没有“连接”的概念），发送数据，读取响应数据，直到数据交换完毕，关闭连接，结束 TCP 对话。

### 服务端过程：

服务端先初始化 Socket，建立流式套接字，与本机地址及端口进行绑定，然后通知 TCP，准备好接收连接，调用 accept() 阻塞，等待来自客户端的连接。如果这时客户端与服务器建立了连接，客户端发送数据请求，服务器接收请求并处理请求，然后把响应数据发送给客户端，客户端读取数据，直到数据交换完毕。最后关闭连接，交互结束。

## 从 TCP 连接的视角看 Socket 过程：

**TCP 三次握手的 Socket 过程：**

![](/images/blog/2018-06-05-Socket-1/Socket_003.jpg)

1. 服务器调用 socket()、bind()、listen() 完成初始化后，调用 accept() 阻塞等待；
2. 客户端 Socket 对象调用 connect() 向服务器发送了一个 SYN 并阻塞；
3. 服务器完成了第一次握手，即发送 SYN 和 ACK 应答；
4. 客户端收到服务端发送的应答之后，从 connect() 返回，再发送一个 ACK 给服务器；
5. 服务器 Socket 对象接收客户端第三次握手 ACK 确认，此时服务端从 accept() 返回，建立连接。

接下来就是两个端的连接对象互相收发数据。

**TCP 四次挥手的 Socket 过程：**

![](/images/blog/2018-06-05-Socket-1/Socket_004.jpg)

1. 某个应用进程调用 close() 主动关闭，发送一个 FIN；
2. 另一端接收到 FIN 后被动执行关闭，并发送 ACK 确认；
3. 之后被动执行关闭的应用进程调用 close() 关闭 Socket，并也发送一个 FIN；
4. 接收到这个 FIN 的一端向另一端 ACK 确认。

> 声明：本站采用开放的[知识共享署名-非商业性使用-相同方式共享 许可协议](https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh)进行许可。
